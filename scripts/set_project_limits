#!/usr/bin/perl

use strict;
use warnings;
use Newton;
use File::Temp 'tempfile';
use Data::Dumper;

my $project = shift @ARGV || die "Need project name";

my $limits = Newton::selectall_arrayref(
  'SELECT username,queue,slots FROM projectlimits WHERE project=? ORDER BY LENGTH(queue)', $project,
  );
die Dumper($limits);
my $rqs; 
for(@$limits){
  my ($username, $queue, $slots) = @$_;
  my $memslots = $slots * 2;
  $rqs .= "limit projects $project queues $queue users $username to slots=$slots,dedicated=$slots,mem=${memslots}G,cores_per_node=$slots\n";
  }

Write("project_$project", $rqs);

sub Write {
  my ($name, $rqs) = @_;
  my ($fh, $file) = tempfile();
  flock($fh, 2) or die $!;
  print {$fh} qq/{
   name         $name
   description  Do not modify this directly, use set_project_limits 
   enabled      TRUE
$rqs
}/;
  close $fh;

  my $cmd = `qconf -srqs '$name'`?'M':'A';
  print `qconf -${cmd}rqs '$file' '$name'`;
  }
