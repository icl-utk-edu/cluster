#!/usr/bin/perl
#
# This puts the head node's current root ssh public key into the puppet 
# class files so that it can be distributed to all machines.
#

open(IN, '/root/.ssh/id_rsa.pub') or die $!;
flock(IN, 2) or die $!;
my $key;
while(<IN>){
  chomp;
  ($key) = /^\S+\s+(\S+)/;
  last if defined $key;
  }
close IN;
die "Error: no ssh key found" unless defined $key;

print <<END
# This is automatically generated by puppet executing /newton/scripts/update_root_ssh_pubkey

class sshpubkeyroot {
  ssh_authorized_key { sshauthkey_root :
    ensure => present,
    key => '$key',
    type => 'ssh-rsa',
    user => 'root'
  }
}

END

