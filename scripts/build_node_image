#!/bin/bash -e

if [ $USER != "root" ]; then
   echo Running as root
   sudo $0 $@
   exit
fi


NAME=$1
DIR=/cluster/nodes/$NAME
if [[ -z "$NAME" || ! -d $DIR ]]; then
	echo "Please provide a valid node image name"
	exit 1
fi


TMPDIR=/tmp/$RANDOM
mkdir -p $TMPDIR

cd $TMPDIR
headnode=`host headnode | awk '{print $4}'`
docker build --progress=plain -t temp --build-arg HEADNODE=$headnode -f $DIR/Dockerfile .
rmdir $TMPDIR

docker remove temp || true
docker run -it --name temp temp sleep 0
rm -rf $DIR/rootfs/* || true
mkdir -p rootfs
cd rootfs
docker export temp | tar -x

cp -a /etc/ssh/ssh_host_rsa* etc/ssh/
chmod 600 etc/ssh/ssh_host*key
cat /root/.ssh/*.pub > root/.ssh/authorized_keys

cd ..
ln -sf rootfs/boot/vmlinuz* kernel
ln -sf rootfs/boot/init*.img initrd


